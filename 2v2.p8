pico-8 cartridge // http://www.pico-8.com
version 16
__lua__

function new_player()
	local player =
	{
		num=0;
		ammo=0;
		shieldtime=0;
		hp=0;
		x=0;
		y=0;
		vx=2;
		vy=0;
		air=false;
		jumping=false;
		t=0.0;
		sprite=0;
		facing_r=true;
	}

	return player
end

k_left=0
k_right=1
k_up=2
k_down=3
k_a=4
k_b=5

val = 0
flag = 0
grav = 0.28
t_step = 0.15
vxmax = 3
maxfall = 4
jumpforce = 4



clouds = {}
for i=0,16 do
	add(clouds,{
		x=rnd(128),
		y=rnd(128),
		spd=1+rnd(4),
		w=32+rnd(32)
	})
end

particles = {}
for i=0,24 do
	add(particles,{
		x=rnd(128),
		y=rnd(128),
		s=0+flr(rnd(5)/4),
		spd=0.25+rnd(5),
		off=rnd(1),
		c=6+flr(0.5+rnd(1))
	})
end

dead_particles = {}



function solid(x, y)
	val=mget(x/8, y/8)
	flag = fget(val, 1)--0 = terrain flag
	return flag
end

function checkcollision(x,y,w,h)
	return
	solid(x-w,y-h) or
	solid(x+w,y-h) or
	solid(x-w,y+h) or
	solid(x+w,y+h)
end

function update_spx(pl)
	-- direction
	dir = btn(k_right, pl.num) and 1 or (btn(k_left, pl.num) and -1 or 0)

	if dir == 0 then
		if abs(pl.t) < 0.16 then
			pl.t = 0
		end

		if pl.t != 0 then
			if pl.t < 0 then
				pl.t += t_step
			else
				pl.t -= t_step
			end
		end
	end

	if dir == 1 then
		if pl.t < 0 then
			pl.t += 0.1
		end
		pl.t += 0.05;
		if pl.t > 1 then
			pl.t = 1;
		end
	end

	if dir == -1 then
		if pl.t>0 then
			pl.t = pl.t - 0.1
		end

		pl.t = pl.t - 0.05
		if pl.t < -1 then
			pl.t = -1
		end
	end

	pl.vx = pl.t*vxmax
end

function update_spy(pl)
	--jump
	if btn(k_up,pl.num) and not pl.air and not pl.jumping then
		pl.vy = -jumpforce
		pl.jumping = true
		pl.air = true
	elseif not pl.air and not solid(pl.x +4, pl.y+8) then
		pl.air = true
	end

	if pl.vy < 0 then -- going upwards
		if (solid(pl.x+4,pl.y-1)) pl.vy = -pl.vy
	elseif solid(pl.x+4, pl.y+8) then -- going downwards and landing
		pl.vy = 0
		pl.air = false
		pl.y = flr(pl.y/8)*8
	end

	if pl.air and pl.vy < maxfall then
		pl.vy += grav
	end

	pl.jumping = pl.vy < 0
end

function update_player_sprite(pl)
	if abs(pl.vx) > 0 then
		pl.sprite = (pl.sprite+1)%3
	else
		pl.sprite = 0
	end
	if pl.vx < 0 then
		pl.facing_r = false
	elseif pl.vx > 0 then
		pl.facing_r = true
	end
	if not pl.facing_r then
		pl.sprite+=3
	end
end

function move(pl)
	update_spx(pl)
	pl.x += pl.vx

	update_spy(pl)
	pl.y += pl.vy

	update_player_sprite(pl)
end

function _init()
	p1 = new_player()
	p2 = new_player()
	p3 = new_player()
	p4 = new_player()

	p1.num = 0
	p1.x = 20
	p1.y = 20
	
	p2.x = 20
	p2.y = 20

	p3.x = 20
	p3.y = 20
	
	p4.x = 20
	p4.y = 20
	
	
	p2.num = 1
	p3.num = 2
	p4.num = 3
end

function _update()
	move(p1)
	move(p2)
	move(p3)
	move(p4)
end

function printplayer(pl)
	spr(16*pl.num+1 + pl.sprite,pl.x,pl.y)
end



function robado()
	foreach(clouds, function(c)
		c.x += c.spd
		rectfill(c.x,c.y,c.x+c.w,c.y+4+(1-c.w/64)*12,new_bg~=nil and 14 or 1)
		if c.x > 128 then
			c.x = -c.w
			c.y=rnd(128-8)
		end
	end)
		
		
	foreach(particles, function(p)
		p.x += p.spd
		p.y += sin(p.off)
		p.off+= min(0.05,p.spd/8)
		rectfill(p.x,p.y,p.x+p.s,p.y+p.s,p.c)
		if p.x>128+4 then 
			p.x=-4
			p.y=rnd(128)
		end
	end)
	
	-- dead particles
	foreach(dead_particles, function(p)
		p.x += p.spd.x
		p.y += p.spd.y
		p.t -=1
		if p.t <= 0 then del(dead_particles,p) end
		rectfill(p.x-p.t/5,p.y-p.t/5,p.x+p.t/5,p.y+p.t/5,14+p.t%2)
	end)

end

function _draw()
	cls()
	robado()
	mapdraw(0, 0, 0, 0, 200, 200)
	print(p1.vx)
	print(p1.vy)
	print(p1.sprite)

	printplayer(p1)
	printplayer(p2)
	
	printplayer(p3)
	printplayer(p4)		
end

__gfx__
0000000007ccccc007ccccc007ccccc007ccccc007ccccc007ccccc0000000000000000000000000000000000000000000000000000000000000000000000000
000000007ccacacc7ccacacc7ccacacc7cacaccc7cacaccc7cacaccc000000000000000000000000000000000000000000000000000000000000000000000000
007007007ccacacd7ccacacd7ccacacd7cacaccd7cacaccd7cacaccd000000000000000000000000000000000000000000000000000000000000000000000000
00077000cccccccdcccccccdcccccccdcccccccdcccccccdcccccccd000000000000000000000000000000000000000000000000000000000000000000000000
000770000dccccd00dccccd00dccccd00dccccd00dccccd00dccccd0000000000000000000000000000000000000000000000000000000000000000000000000
0070070000dddd0000dddd0000dddd0000dddd0000dddd0000dddd00000000000000000000000000000000000000000000000000000000000000000000000000
0000000000d00d0000d00d0000d00d0000d00d0000d00d0000d00d00000000000000000000000000000000000000000000000000000000000000000000000000
0000000000d00d0000000d0000d0000000d00d0000000d0000d00000000000000000000000000000000000000000000000000000000000000000000000000000
666666660b3333300b3333300b3333300b3333300b3333300b333330000000000000000000000000000000000000000000000000000000000000000000000000
6777777db33a3a33b33a3a33b33a3a33b3a3a333b3a3a333b3a3a333000000000000000000000000000000000000000000000000000000000000000000000000
6766666db33a3a31b33a3a31b33a3a31b3a3a331b3a3a331b3a3a331000000000000000000000000000000000000000000000000000000000000000000000000
d6ddddd5333333313333333133333331333333313333333133333331000000000000000000000000000000000000000000000000000000000000000000000000
5dddddd5013333100133331001333310013333100133331001333310000000000000000000000000000000000000000000000000000000000000000000000000
5dddddd5001111000011110000111100001111000011110000111100000000000000000000000000000000000000000000000000000000000000000000000000
5dddddd5001001000010010000100100001001000010010000100100000000000000000000000000000000000000000000000000000000000000000000000000
55555555001001000000010000100000001001000000010000100000000000000000000000000000000000000000000000000000000000000000000000000000
0000000007aaaaa007aaaaa007aaaaa007aaaaa007aaaaa007aaaaa0000000000000000000000000000000000000000000000000000000000000000000000000
000000007aa8a8aa7aa8a8aa7aa8a8aa7a8a8aaa7a8a8aaa7a8a8aaa000000000000000000000000000000000000000000000000000000000000000000000000
000000007aa8a8a97aa8a8a97aa8a8a97a8a8aa97a8a8aa97a8a8aa9000000000000000000000000000000000000000000000000000000000000000000000000
00000000aaaaaaa9aaaaaaa9aaaaaaa9aaaaaaa9aaaaaaa9aaaaaaa9000000000000000000000000000000000000000000000000000000000000000000000000
0000000009aaaa9009aaaa9009aaaa9009aaaa9009aaaa9009aaaa90000000000000000000000000000000000000000000000000000000000000000000000000
00000000009999000099990000999900009999000099990000999900000000000000000000000000000000000000000000000000000000000000000000000000
00000000009009000090090000900900009009000090090000900900000000000000000000000000000000000000000000000000000000000000000000000000
00000000009009000000090000900000009009000000090000900000000000000000000000000000000000000000000000000000000000000000000000000000
00000000076666600766666007666660076666600766666007666660000000000000000000000000000000000000000000000000000000000000000000000000
00000000766868667668686676686866768686667686866676868666000000000000000000000000000000000000000000000000000000000000000000000000
000000007668686d7668686d7668686d7686866d7686866d7686866d000000000000000000000000000000000000000000000000000000000000000000000000
000000006666666d6666666d6666666d6666666d6666666d6666666d000000000000000000000000000000000000000000000000000000000000000000000000
000000000d6666d00d6666d00d6666d00d6666d00d6666d00d6666d0000000000000000000000000000000000000000000000000000000000000000000000000
0000000000dddd0000dddd0000dddd0000dddd0000dddd0000dddd00000000000000000000000000000000000000000000000000000000000000000000000000
0000000000d00d0000d00d0000d00d0000d00d0000d00d0000d00d00000000000000000000000000000000000000000000000000000000000000000000000000
0000000000d00d0000000d0000d0000000d00d0000000d0000d00000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000002000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0010171717171717171717171710000010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0010171717171717171717171710000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0010171717171717171717170010000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0010001717171717171010101010000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0010000017171717171717171710000000000010002020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0010000000001717170000001710000000000010000000202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0010101010101010101010101010000010101010000000000020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0010000017171717171700000017170000000010000000000020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0010001717171717171717171717171700000010000000000020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0010000000171717000000000000171700000010000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0010000000171700000000000000000000000010000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0010101010101010101010101010101010101010000020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000001700202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000200017171717171717171717171717202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000020202000201720172020200020202017200000202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000200020001717000000002020000000002020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000202020202020202020202020202020202020202000202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000002020000000000000002020200000000000000020002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100001035014350193501b3501d3501f3502335023350253502535025350253502435022350213501d350183501635014350133501135011350103500f3501535016350163502935000000000000000000000
0012000000000000001535017350183501b3501a35023350263501b3501c3501c3501d3501f3503335023350223501e3501c350393501435012350123503a3503935035350123502e3502c35027350233501e350
00100000353203a3103b3203b32035330323402f3402e3502e3402e3402f3503236035340363203632036340373403535033360313602f3602f36030350323403333035330373303734035360303703136036350
